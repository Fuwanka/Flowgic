{% extends 'base.html' %}
{% block extra_styles %}
<style>
    /* ========= –ö–†–ê–°–ò–í–´–ï –°–¢–ê–¢–£–°–´ ========= */

    .status-badge {
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-block;
    }

    .status-new {
        background: #0d6efd22;
        color: #0d6efd;
        border: 1px solid #0d6efd55;
    }

    .status-in_progress {
        background: #ffc10722;
        color: #b58100;
        border: 1px solid #ffc10755;
    }

    .status-completed {
        background: #19875422;
        color: #0f5132;
        border: 1px solid #19875466;
    }

    .status-cancelled {
        background: #dc354522;
        color: #842029;
        border: 1px solid #dc354566;
    }
</style>
{% endblock %}

{% block title %}–ü–∞–Ω–µ–ª—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞{% endblock %}

{% block content %}
<div class="container-fluid dashboard-fluid">
  <div class="dashboard-wrapper">
    {% include 'dashboard/_sidebar.html' %}
    <div class="dashboard-content">
      {% block dashboard_content %}
      <h1 class="mb-3">–ü–∞–Ω–µ–ª—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞</h1>

      <script>
        console.log('events_json:', '{{ events_json|safe }}');
      </script>

      <div class="d-flex justify-content-between mb-3">
        <div class="filters">
          <button class="btn btn-outline-primary filter-btn active">–í—Å–µ</button>
          <button class="btn btn-outline-secondary filter-btn">–ù–æ–≤—ã–µ</button>
          <button class="btn btn-outline-warning filter-btn">–í –ø—É—Ç–∏</button>
          <button class="btn btn-outline-success filter-btn">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
          <button class="btn btn-outline-danger filter-btn">–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</button>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'create_client' %}" class="btn btn-success">üë§ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</a>
          <a href="{% url 'create_vehicle' %}" class="btn btn-info text-white">üöõ –ù–æ–≤–æ–µ –¢–°</a>
          <a href="{% url 'new_request' %}" class="btn btn-primary">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</a>
          <button type="button" class="btn btn-outline-primary" id="openCalendarBtn">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
        </div>
      </div>

      <table class="table table-hover">
        <thead>
          <tr>
            <th>‚Ññ –∑–∞–∫–∞–∑–∞</th>
            <th>–ì—Ä—É–∑</th>
            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
            <th>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–û–ø–ª–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for req in requests %}
          <tr>
            <td><a href="{% url 'request_detail' req.id %}">{{ req.order_number }}</a></td>
            <td>{{ req.cargo_type }}</td>
            <td>{{ req.origin }} ‚Üí {{ req.destination }}</td>
            <td>{% if req.driver %}{{ req.driver.full_name }}{% else %}‚Äî{% endif %}</td>
            <td>{% if req.vehicle %}{{ req.vehicle.reg_number }}{% else %}‚Äî{% endif %}</td>
            <td>
                <span class="status-badge status-{{ req.status|lower }}">
                    {{ req.get_status_display }}
                </span>
            </td>
            <td>
              {% if req.financial %}
              <span class="badge
                      {% if req.financial.payment_status == 'paid' %}bg-success
                      {% elif req.financial.payment_status == 'partially_paid' %}bg-warning
                      {% else %}bg-danger{% endif %}">
                {{ req.financial.get_payment_status_display }}
              </span>
              {% else %}
              <span class="badge bg-secondary">‚Äî</span>
              {% endif %}
            </td>
            <td><a href="{% url 'request_detail' req.id %}" class="btn btn-sm btn-outline-primary">–û—Ç–∫—Ä—ã—Ç—å</a></td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center">–ó–∞—è–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endblock %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<div class="modal fade" id="calendarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–∫–∞–∑–æ–≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="dashboard-calendar" style="height: 600px;"></div>
      </div>
    </div>
  </div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('dashboard-calendar');
  if (calendarEl) {
    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'ru',
      initialView: 'dayGridMonth',
      firstDay: 1,
      height: 'auto',
      events: {{ events_json|safe }},
      eventClick: function(info) {
        alert(
          `–ó–∞–∫–∞–∑: ${info.event.title}\n` +
          `–ì—Ä—É–∑: ${info.event.extendedProps.cargo}\n` +
          `–°—Ç–∞—Ç—É—Å: ${info.event.extendedProps.status}`
        );
      }
    });
    calendar.render();
  }

  const btn = document.getElementById('openCalendarBtn');
  if (btn) {
    btn.addEventListener('click', () => {
      const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
      modal.show();
    });
  }
});
</script>
{% endblock %}
