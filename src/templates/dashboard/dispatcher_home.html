{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid dashboard-fluid">
  <div class="dashboard-wrapper">
    {% include 'dashboard/_sidebar.html' %}
    <div class="dashboard-content">
      {% block dashboard_content %}
      <h1 class="mb-3">Dashboard</h1>

      <!-- ÐžÐ¢Ð›ÐÐ”ÐšÐ: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ events_json -->
      <script>
        console.log('events_json:', '{{ events_json|safe }}');
      </script>

      <div class="d-flex justify-content-between mb-3">
        <div class="filters">
          <button class="btn btn-outline-primary filter-btn active">All</button>
          <button class="btn btn-outline-secondary filter-btn">New</button>
          <button class="btn btn-outline-warning filter-btn">In Transit</button>
          <button class="btn btn-outline-success filter-btn">Completed</button>
          <button class="btn btn-outline-danger filter-btn">Cancelled</button>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'create_client' %}" class="btn btn-success">ðŸ‘¤ New Client</a>
          <a href="{% url 'create_vehicle' %}" class="btn btn-info text-white">ðŸš› New Vehicle</a>
          <a href="{% url 'new_request' %}" class="btn btn-primary">âž• New Request</a>
          <!-- ÐšÐÐžÐŸÐšÐ ÐšÐÐ›Ð•ÐÐ”ÐÐ Ð¯ -->
          <button type="button" class="btn btn-outline-primary" id="openCalendarBtn">ðŸ“… ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ</button>
        </div>
      </div>

      <table class="table table-hover">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Cargo</th>
            <th>Route</th>
            <th>Driver</th>
            <th>Vehicle</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for req in requests %}
          <tr>
            <td><a href="{% url 'request_detail' req.id %}">{{ req.order_number }}</a></td>
            <td>{{ req.cargo_type }}</td>
            <td>{{ req.origin }} â†’ {{ req.destination }}</td>
            <td>{% if req.driver %}{{ req.driver.full_name }}{% else %}â€”{% endif %}</td>
            <td>{% if req.vehicle %}{{ req.vehicle.reg_number }}{% else %}â€”{% endif %}</td>
            <td><span class="badge bg-{{ req.status|lower }}">{{ req.get_status_display }}</span></td>
            <td>
              {% if req.financial %}
              <span class="badge
                      {% if req.financial.payment_status == 'paid' %}bg-success
                      {% elif req.financial.payment_status == 'partially_paid' %}bg-warning
                      {% else %}bg-danger{% endif %}">
                {{ req.financial.get_payment_status_display }}
              </span>
              {% else %}
              <span class="badge bg-secondary">â€”</span>
              {% endif %}
            </td>
            <td><a href="{% url 'request_detail' req.id %}" class="btn btn-sm btn-outline-primary">View</a></td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center">No requests found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endblock %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ“… ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="dashboard-calendar" style="height: 600px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('dashboard-calendar');
  if (calendarEl) {
    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'ru',
      initialView: 'dayGridMonth',
      firstDay: 1,
      height: 'auto',
      events: {{ events_json|safe }},
      eventClick: function(info) {
        alert(
          `Ð—Ð°ÐºÐ°Ð·: ${info.event.title}\n` +
          `Ð“Ñ€ÑƒÐ·: ${info.event.extendedProps.cargo}\n` +
          `Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ${info.event.extendedProps.status}`
        );
      }
    });
    calendar.render();
  }

  const btn = document.getElementById('openCalendarBtn');
  if (btn) {
    btn.addEventListener('click', () => {
      const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
      modal.show();
    });
  }
});
</script>
{% endblock %}
