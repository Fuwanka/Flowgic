{% load static %}
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ó–∞–∫–∞–∑ {{ order.id }}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/request_detail.css' %}">
</head>

<body>
    <div class="dashboard-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞ –∑–∞–∫–∞–∑–∞ -->
        <div class="dashboard-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <div class="dashboard-title" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span>–ó–∞–∫–∞–∑ #{% if order.id|stringformat:"s"|length > 8 %}{{ order.id|stringformat:"s"|slice:":8" }}...{% else %}{{ order.id }}{% endif %}</span>
                <span class="status-badge status-{{ order.status }}" id="order-status-badge">{{ order.get_status_display }}</span>

                {% if user.role in 'dispatcher manager' %}
                <div style="display:flex; align-items:center; gap:10px;">
                    {% csrf_token %}
                    <select id="status-select" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem; cursor:pointer;">
                        <option value="">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å...</option>
                        {% for choice in status_choices %}
                        <option value="{{ choice.0 }}" {% if order.status == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                        {% endfor %}
                    </select>
                    <div id="status-message" style="font-size:0.85rem; display:none;"></div>
                </div>
                {% endif %}
            </div>
            <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                <span class="text-muted" style="font-size:0.9rem;">
                    –°–æ–∑–¥–∞–Ω {{ order.created_at|date:"d M, H:i" }} {% if order.created_by %} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {{ order.created_by.full_name|default:order.created_by.get_full_name|default:order.created_by.email }}{% else %}–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ{% endif %}
                </span>
                <a href="{% url 'home' %}" class="close-btn">–ó–∞–∫—Ä—ã—Ç—å</a>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- –ö–æ–ª–æ–Ω–∫–∞ 1: –ö–ª–∏–µ–Ω—Ç –∏ –ì—Ä—É–∑ -->
            <div class="dashboard-column">
                <div class="info-card">
                    <div class="card-title">üè¢ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</div>
                    <div class="info-row">
                        <span class="info-label">–ö–æ–º–ø–∞–Ω–∏—è</span>
                        <span class="info-value">{{ order.client.company.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ö–æ–Ω—Ç–∞–∫—Ç</span>
                        <span class="info-value">{{ order.client.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                        <span class="info-value">{{ order.client.phone|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value">{{ order.client.email|default:"-" }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="card-title">üì¶ –ì—Ä—É–∑</div>
                    <div class="info-row">
                        <span class="info-label">–¢–∏–ø</span>
                        <span class="info-value">{{ order.cargo_type }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ú–∞—Å—Å–∞</span>
                        <span class="info-value">{{ order.cargo_mass_kg }} –∫–≥</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="card-title">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>
                    {% if user.role in 'dispatcher manager' %}
                    <form id="financial-form" style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
                        {% csrf_token %}
                        <div class="info-row">
                            <span class="info-label">–î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <input type="text" id="id_client_cost" name="client_cost"
           value="{{ order.financial.client_cost|floatformat:2 }}"
           style="width:120px; padding:4px 8px; border:1px solid #ccc; border-radius:4px;">
        </div>
                        <div class="info-row">
                            <label for="id_fuel_expenses" class="info-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ:</label>
                            <input type="text" id="id_fuel_expenses" value="{{ order.financial.fuel_expenses|floatformat:2 }}" style="width:120px; padding:4px 8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="info-row">
                            <label for="id_driver_cost" class="info-label">–û–ø–ª–∞—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é:</label>
                            <input type="text" id="id_driver_cost" value="{{ order.financial.driver_cost|floatformat:2 }}" style="width:120px; padding:4px 8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="info-row">
                            <label class="info-label">–ü—Ä–∏–±—ã–ª—å:</label>
                            <span id="profit-display" class="info-value text-success" style="font-weight:bold; margin-left:8px;">{{ order.financial.profit|floatformat:2 }}</span>
                        </div>
                        <button type="submit" class="btn-update-payment" style="padding:8px 12px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.9rem;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã</button>
                        <div id="financial-message" style="font-size:0.85rem; display:none;"></div>
                    </form>
                    {% else %}
                    <div class="info-row">
                        <span class="info-label">–î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
                        <span class="info-value">{{ order.financial.client_cost|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ</span>
                        <span class="info-value">{{ order.financial.fuel_expenses|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–û–ø–ª–∞—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é</span>
                        <span class="info-value">{{ order.financial.driver_cost|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ü—Ä–∏–±—ã–ª—å</span>
                        <span class="info-value text-success">{{ order.financial.profit|default:"-" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞ 2: –ú–∞—Ä—à—Ä—É—Ç –∏ —Ä–µ—Å—É—Ä—Å—ã -->
            <div class="dashboard-column">
                <div class="info-card">
                    <div class="card-title">üìç –ú–∞—Ä—à—Ä—É—Ç</div>
                    <div class="info-row">
                        <span class="info-label">–û—Ç–∫—É–¥–∞</span>
                        <span class="info-value">{{ order.origin }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏</span>
                        <span class="info-value">{{ order.pickup_datetime|date:"d M, H:i" }}</span>
                    </div>
                    <hr class="divider">
                    <div class="info-row">
                        <span class="info-label">–ö—É–¥–∞</span>
                        <span class="info-value">{{ order.destination }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                        <span class="info-value">{{ order.delivery_datetime|date:"d M, H:i" }}</span>
                    </div>
                    {% if order.distance_km %}
                    <div class="info-row" style="margin-top:10px;">
                        <span class="info-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</span>
                        <span class="info-value">{{ order.distance_km }} –∫–º</span>
                    </div>
                    {% endif %}
                </div>

                <div class="info-card">
                    <div class="card-title">üöö –†–µ—Å—É—Ä—Å—ã</div>
                    <div class="info-row">
                        <span class="info-label">–í–æ–¥–∏—Ç–µ–ª</span>
                        <span class="info-value">{% if order.driver %}{{ order.driver.full_name }}{% else %}<span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>{% endif %}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</span>
                        <span class="info-value">{% if order.vehicle %}{{ order.vehicle.reg_number }}{% else %}<span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>{% endif %}</span>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞ 3: –ò—Å—Ç–æ—Ä–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã -->
            <div class="dashboard-column">
                <div class="info-card" style="flex:1; display:flex; flex-direction:column;">
                    <div class="card-title">üïí –ò—Å—Ç–æ—Ä–∏—è</div>
                    <div class="history-list" id="history-list">
                        {% for event in order.events.all %}
                        <div class="history-item">
                            <span class="history-icon">‚óè</span>
                            <div class="history-content">
                                <div><strong>{{ event.get_event_type_display }}</strong></div>
                                {% if event.event_data %}
                                <div style="font-size:0.8rem; color:#666;">
                                    {% if event.event_data.action == 'marked_as_paid' %}
                                    –ó–∞–∫–∞–∑ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π<br>
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ event.order.created_by.full_name|default:order.created_by.get_full_name }}
                                    {% elif event.event_data.action == 'partial_payment' %}
                                    –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞: <strong>{{ event.event_data.amount }} ‚ÇΩ</strong><br>
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ event.order.created_by.full_name|default:order.created_by.get_full_name }}
                                    {% elif event.event_data.old_status %}
                                    –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω:
                                    {% for status_key, status_label in status_choices %}
                                    {% if status_key == event.event_data.old_status %}{{ status_label }}{% endif %}
                                    {% endfor %}
                                    ‚Üí
                                    {% for status_key, status_label in status_choices %}
                                    {% if status_key == event.event_data.new_status %}{{ status_label }}{% endif %}
                                    {% endfor %}
                                    <br>
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ event.order.created_by.full_name|default:order.created_by.get_full_name }}
                                    {% elif event.event_data.old_fuel_expenses %}
                                    –§–∏–Ω–∞–Ω—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã:<br>
                                    –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ: {{ event.event_data.old_fuel_expenses }} ‚Üí {{ event.event_data.new_fuel_expenses }}<br>
                                    –û–ø–ª–∞—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é: {{ event.event_data.old_driver_cost }} ‚Üí {{ event.event_data.new_driver_cost }}<br>
                                    –ü—Ä–∏–±—ã–ª—å: {{ event.event_data.old_profit }} ‚Üí {{ event.event_data.new_profit }}<br>
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ event.event_data.user }}
                                    {% else %}
                                    {{ event.event_data }}
                                    {% endif %}
                                </div>
                                {% endif %}
                                <div class="history-time">{{ event.created_at|date:"d M, H:i" }}</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-muted" style="font-style:italic; padding:10px;">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>
                        {% endfor %}
                    </div>
                </div>

                {% if order.documents.exists %}
                <div class="info-card">
                    <div class="card-title">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
                    {% for doc in order.documents.all %}
                    <a href="{{ doc.file_url|default:'#' }}" target="_blank" class="document-link">
                        {{ doc.get_type_display }} ‚Ññ{{ doc.number }}
                        <span style="float:right; font-size:0.8rem; color:#666;">{{ doc.get_status_display }}</span>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- JS —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <script src="{% static 'js/request_detail.js' %}"></script>
</body>
</html>
