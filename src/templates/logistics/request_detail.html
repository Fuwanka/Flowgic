{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Request {{ order.id }}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/request_detail.css' %}">
</head>

<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <span>Request #{{ order.id|stringformat:"s"|slice:":8" }}...</span>
                <span class="status-badge status-{{ order.status }}" id="order-status-badge">{{ order.get_status_display
                    }}</span>

                {% if user.role == 'dispatcher' or user.role == 'manager' %}
                <!-- Quick Status Change -->
                <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                    {% csrf_token %}
                    <select id="status-select"
                        style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                        <option value="">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å...</option>
                        {% for choice in status_choices %}
                        <option value="{{ choice.0 }}" {% if order.status is choice.0 %}selected{% endif %}>{{ choice.1
                            }}
                        </option>
                        {% endfor %}
                    </select>
                    <div id="status-message" style="font-size: 0.85rem; display: none;"></div>
                </div>
                {% endif %}
            </div>
            <div>
                <span class="text-muted" style="font-size: 0.9rem; margin-right: 15px;">
                    Created {{ order.created_at|date:"M d, H:i" }} by {% if order.created_by %}{{
                    order.created_by.full_name|default:order.created_by.get_full_name|default:order.created_by.email
                    }}{% else %}Unknown{% endif %}
                </span>
                <a href="{% url 'home' %}" class="close-btn">Close</a>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- Column 1: Client & Cargo -->
            <div class="dashboard-column">
                <div class="info-card">
                    <div class="card-title">üè¢ Client Details</div>
                    <div class="info-row">
                        <span class="info-label">Company</span>
                        <span class="info-value">{{ order.client.company.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Contact</span>
                        <span class="info-value">{{ order.client.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone</span>
                        <span class="info-value">{{ order.client.phone|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value">{{ order.client.email|default:"-" }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="card-title">üì¶ Cargo</div>
                    <div class="info-row">
                        <span class="info-label">Type</span>
                        <span class="info-value">{{ order.cargo_type }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Mass</span>
                        <span class="info-value">{{ order.cargo_mass_kg }} kg</span>
                    </div>
                </div>

                <!-- Financials -->
                <div class="info-card">
                    <div class="card-title">üí∞ Financials - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</div>

                    {% if user.role == 'dispatcher' or user.role == 'manager' %}
                    <!-- Financial Edit Form -->
                    <form id="financial-form"
                        style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
                        {% csrf_token %}

                        <!-- –î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–∏–∑ Order) -->
                        <div class="info-row">
                            <label for="id_agreed_price" class="info-label">–î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</label>
                            <input type="number" step="0.01" min="0" id="id_agreed_price"
                                value="{% if order.agreed_price %}{{ order.agreed_price }}{% else %}0.00{% endif %}"
                                style="width: 120px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>

                        <!-- –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ -->
                        <div class="info-row">
                            <label for="id_fuel_expenses" class="info-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ:</label>
                            <input type="number" step="0.01" min="0" id="id_fuel_expenses"
                                value="{{ order.financial.fuel_expenses|floatformat:2 }}"
                                style="width: 120px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>

                        <!-- –û–ø–ª–∞—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é -->
                        <div class="info-row">
                            <label for="id_driver_cost" class="info-label">–û–ø–ª–∞—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é:</label>
                            <input type="number" step="0.01" min="0" id="id_driver_cost"
                                value="{{ order.financial.driver_cost|floatformat:2 }}"
                                style="width: 120px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>

                        <!-- –ü—Ä–∏–±—ã–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) -->
                        <div class="info-row">
                            <label class="info-label">–ü—Ä–∏–±—ã–ª—å:</label>
                            <span id="profit-display" class="info-value text-success"
                                style="font-weight: bold; margin-left: 8px;">
                                {{ order.financial.profit|floatformat:2 }}
                            </span>
                        </div>

                        <button type="submit" class="btn-update-payment"
                            style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã
                        </button>
                        <div id="financial-message" style="font-size: 0.85rem; display: none;"></div>
                    </form>


                    {% else %}
                    <!-- –î–ª—è –≤–æ–¥–∏—Ç–µ–ª—è ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä -->
                    <div class="info-row">
                        <span class="info-label">–î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
                        <span class="info-value">{{ order.agreed_price|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ</span>
                        <span class="info-value">{{ order.financial.fuel_expenses|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–û–ø–ª–∞—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é</span>
                        <span class="info-value">{{ order.financial.driver_cost|default:"-" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ü—Ä–∏–±—ã–ª—å</span>
                        <span class="info-value text-success">{{ order.financial.profit|default:"-" }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Column 2: Route & Resources -->
                <div class="dashboard-column">
                    <div class="info-card">
                        <div class="card-title">üìç Route</div>
                        <div class="info-row">
                            <span class="info-label">Origin</span>
                            <span class="info-value">{{ order.origin }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Pickup</span>
                            <span class="info-value">{{ order.pickup_datetime|date:"M d, H:i" }}</span>
                        </div>
                        <hr class="divider">
                        <div class="info-row">
                            <span class="info-label">Destination</span>
                            <span class="info-value">{{ order.destination }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Delivery</span>
                            <span class="info-value">{{ order.delivery_datetime|date:"M d, H:i" }}</span>
                        </div>
                        {% if order.distance_km %}
                        <div class="info-row" style="margin-top: 10px;">
                            <span class="info-label">Distance</span>
                            <span class="info-value">{{ order.distance_km }} km</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="info-card">
                        <div class="card-title">üöö Resources</div>
                        <div class="info-row">
                            <span class="info-label">Driver</span>
                            <span class="info-value">
                                {% if order.driver %}{{ order.driver.get_full_name|default:order.driver.username }}
                                {% else %}<span class="text-muted">Unassigned</span>{% endif %}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Vehicle</span>
                            <span class="info-value">
                                {% if order.vehicle %}{{ order.vehicle.reg_number }}
                                {% else %}<span class="text-muted">Unassigned</span>{% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Column 3: History & Documents -->
                <div class="dashboard-column">
                    <div class="info-card" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="card-title">üïí History</div>
                        <div class="history-list" id="history-list">
                            {% for event in order.events.all %}
                            <div class="history-item">
                                <span class="history-icon">‚óè</span>
                                <div class="history-content">
                                    <div><strong>{{ event.get_event_type_display }}</strong></div>
                                    {% if event.event_data %}
                                    <div style="font-size: 0.8rem; color: #666;">
                                        {% if event.event_data.action == 'marked_as_paid' %}
                                        –ó–∞–∫–∞–∑ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π<br>
                                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{
                                        event.order.created_by.full_name|default:order.created_by.get_full_name }}
                                        {% elif event.event_data.action == 'partial_payment' %}
                                        –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞: <strong>{{ event.event_data.amount }} ‚ÇΩ</strong><br>
                                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{
                                        event.order.created_by.full_name|default:order.created_by.get_full_name }}
                                        {% elif event.event_data.old_status %}
                                        –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω:
                                        {% for status_key, status_label in status_choices %}
                                        {% if status_key == event.event_data.old_status %}{{ status_label }}{% endif %}
                                        {% endfor %}
                                        ‚Üí
                                        {% for status_key, status_label in status_choices %}
                                        {% if status_key == event.event_data.new_status %}{{ status_label }}{% endif %}
                                        {% endfor %}
                                        <br>
                                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{
                                        event.order.created_by.full_name|default:order.created_by.get_full_name }}
                                        {% else %}
                                        {{ event.event_data }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="history-time">{{ event.created_at|date:"M d, H:i" }}</div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-muted" style="font-style: italic; padding: 10px;">No events yet.</div>
                            {% endfor %}
                        </div>
                    </div>

                    {% if order.documents.exists %}
                    <div class="info-card">
                        <div class="card-title">üìÑ Documents</div>
                        {% for doc in order.documents.all %}
                        <a href="{{ doc.file_url|default:'#' }}" target="_blank" class="document-link">
                            {{ doc.get_type_display }} ‚Ññ{{ doc.number }}
                            <span style="float: right; font-size: 0.8rem; color: #666;">{{ doc.get_status_display
                                }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <script>
            // Status change dropdown handler
            document.getElementById('status-select')?.addEventListener('change', async function () {
                const newStatus = this.value;
                const messageEl = document.getElementById('status-message');
                const badge = document.getElementById('order-status-badge');
                const selectEl = this;

                if (!newStatus) {
                    // Reset to current status if empty option selected
                    selectEl.value = '{{ order.status }}';
                    return;
                }

                const formData = new FormData();
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfToken) {
                    messageEl.textContent = '‚úó –û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    messageEl.style.color = '#c62828';
                    messageEl.style.display = 'block';
                    selectEl.value = '{{ order.status }}';
                    return;
                }
                formData.append('csrfmiddlewaretoken', csrfToken.value);
                formData.append('status', newStatus);

                try {
                    const response = await fetch('{% url "update_order_status" order.id %}', { method: 'POST', body: formData });
                    const data = await response.json();

                    if (data.success) {
                        badge.className = 'status-badge status-' + data.status;
                        badge.textContent = data.status_display;
                        messageEl.textContent = '‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ';
                        messageEl.style.color = '#388e3c';
                        messageEl.style.display = 'block';
                        // Update select to show new status
                        selectEl.value = data.status;
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        messageEl.textContent = '‚úó ' + data.error;
                        messageEl.style.color = '#c62828';
                        messageEl.style.display = 'block';
                        // Reset to current status on error
                        selectEl.value = '{{ order.status }}';
                        setTimeout(() => messageEl.style.display = 'none', 3000);
                    }
                } catch (error) {
                    messageEl.textContent = '‚úó –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                    messageEl.style.color = '#c62828';
                    messageEl.style.display = 'block';
                    // Reset to current status on error
                    selectEl.value = '{{ order.status }}';
                    setTimeout(() => messageEl.style.display = 'none', 3000);
                }
            });

            // Financial form AJAX submission
            document.getElementById('financial-form')?.addEventListener('submit', async function (e) {
                e.preventDefault();

                const agreedPrice = document.getElementById('id_agreed_price').value;
                const fuelExpenses = document.getElementById('id_fuel_expenses').value;
                const driverCost = document.getElementById('id_driver_cost').value;
                const msgEl = document.getElementById('financial-message');

                if (!agreedPrice || parseFloat(agreedPrice) <= 0) {
                    msgEl.textContent = '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å';
                    msgEl.style.color = '#c62828';
                    msgEl.style.display = 'block';
                    return;
                }

                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                formData.append('agreed_price', agreedPrice);
                formData.append('fuel_expenses', fuelExpenses || '0.00');
                formData.append('driver_cost', driverCost || '0.00');

                try {
                    const response = await fetch('{% url "update_financials" order.id %}', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏
                        document.getElementById('profit-display').textContent = data.profit;
                        msgEl.textContent = '‚úì –§–∏–Ω–∞–Ω—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã';
                        msgEl.style.color = '#388e3c';
                        msgEl.style.display = 'block';
                        setTimeout(() => msgEl.style.display = 'none', 3000);
                    } else {
                        msgEl.textContent = '‚úó ' + data.error;
                        msgEl.style.color = '#c62828';
                        msgEl.style.display = 'block';
                    }
                } catch (error) {
                    msgEl.textContent = '‚úó –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                    msgEl.style.color = '#c62828';
                    msgEl.style.display = 'block';
                }
            });

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            ['id_agreed_price', 'id_fuel_expenses', 'id_driver_cost'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', () => {
                    const ap = parseFloat(document.getElementById('id_agreed_price').value) || 0;
                    const fe = parseFloat(document.getElementById('id_fuel_expenses').value) || 0;
                    const dc = parseFloat(document.getElementById('id_driver_cost').value) || 0;
                    const tp = 0; // –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    const profit = ap - fe - dc - tp;
                    document.getElementById('profit-display').textContent = profit.toFixed(2);
                });
            });
        </script>
</body>

</html>